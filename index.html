<!DOCTYPE html>
<html lang="en">

<head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>ƒê·∫•u Tr∆∞·ªùng AI - Qu·∫£n Tr·ªã Game</title>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
      <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
      <style>
            body {
                  background-color: #c4def8;
                  margin: 0;
                  padding: 0;
            }

            .team-avatar {
                  width: 60px;
                  height: 60px;
                  object-fit: cover;
                  border-radius: 9999px;
            }

            .expandable-section {
                  overflow: hidden;
                  transition: max-height 0.4s ease;
                  max-height: 1000px;
                  /* m·∫∑c ƒë·ªãnh m·ªü r·ªông */
            }

            .expandable-section.collapsed {
                  max-height: 0;
            }

            #round-content {
                  opacity: 1;
                  transition: opacity 0.3s ease-in-out;
            }

            #round-content.fade-out {
                  opacity: 0;
            }

            .cart-team-shadow {
                  box-shadow: rgba(0, 0, 0, 0.25) 0px 54px 55px, rgba(0, 0, 0, 0.12) 0px -12px 30px, rgba(0, 0, 0, 0.12) 0px 4px 6px, rgba(0, 0, 0, 0.17) 0px 12px 13px, rgba(0, 0, 0, 0.09) 0px -3px 5px;
            }

            .cart-table-shadow {
                  box-shadow: rgba(0, 0, 0, 0.25) 0px 54px 55px, rgba(0, 0, 0, 0.12) 0px -12px 30px, rgba(0, 0, 0, 0.12) 0px 4px 6px, rgba(0, 0, 0, 0.17) 0px 12px 13px, rgba(0, 0, 0, 0.09) 0px -3px 5px;
            }

            .bg-color-gray-red {
                  background-color: #dbcfcf;
            }
            .no-chiem{
                  color: rgb(255 114 114);
            }
            .yes-chiem{
                  color: rgb(158 255 207)
            }
      </style>
</head>

<body>
      <h1 class="text-3xl font-bold text-center p-5 mb-6 bg-blue-600 text-white">Qu·∫£n Tr·ªã Game: ƒê·∫•u Tr∆∞·ªùng AI</h1>
      <div class="max-w-8xl mx-auto px-2">

            <!-- Th√¥ng b√°o popup -->
            <div id="toastSuccess"
                  class="fixed top-4 right-4 z-50 hidden bg-green-500 text-white px-4 py-2 rounded shadow">
            </div>
            <div id="toastFailed"
                  class="fixed top-4 right-4 z-50 hidden bg-red-500 text-white px-4 py-2 rounded shadow">
            </div>

            <!-- PH·∫¶N 1: SETUP ƒê·ªôi Ch∆°i -->
            <section id="setup-game" class="mb-10 px-4">
                  <div class="bg-white shadow rounded-xl p-6">
                        <div class="flex justify-between items-center mb-6 border-b pb-3">
                              <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    üéÆ Setup ƒê·ªôi Ch∆°i
                              </h2>
                              <div class="space-x-2">
                                    <button onclick="openTeamModal()"
                                          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition">
                                          <i class="fa-solid fa-plus mr-2"></i>Th√™m ƒë·ªôi</button>
                                    <button onclick="resetTeams()"
                                          class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow transition">
                                          <i class="fa-solid fa-trash mr-2"></i> Reset D·ªØ Li·ªáu ƒê·ªòi</button>
                              </div>
                        </div>

                        <div class="flex justify-between items-center mb-4">
                              <h3 class="text-lg font-semibold text-gray-700">üìã Danh S√°ch C√°c ƒê·ªôi Tham Gia</h3>
                              <div class="space-x-2">
                                    <button id="btnExpandTeams" onclick="toggleTeams(true)"
                                          class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded hidden">
                                          <i class="fa-solid fa-chevron-down mr-1"></i> M·ªü r·ªông
                                    </button>
                                    <button id="btnCollapseTeams" onclick="toggleTeams(false)"
                                          class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded">
                                          <i class="fa-solid fa-chevron-up mr-1"></i> Thu g·ªçn
                                    </button>
                              </div>
                        </div>

                        <!-- ƒê√¢y l√† n∆°i ch·ª©a danh s√°ch c√°c ƒë·ªôi -->
                        <div id="teams-section" class="expandable-section">
                              <div id="teams-container" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                        </div>

                  </div>
            </section>

            <!-- PH·∫¶N 1: SETUP T√≤a Th√†nh AI -->
            <section id="castle-setup" class="mb-10 px-4">
                  <div class="bg-white shadow rounded-xl p-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-3">
                              <h2 class="text-2xl font-bold text-gray-800">üèØ Setup T√≤a Th√†nh AI</h2>
                              <div class="space-x-2">
                                    <button onclick="openCastleModal()"
                                          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                                          <i class="fa-solid fa-plus mr-1"></i> Th√™m T√≤a Th√†nh
                                    </button>
                                    <button onclick="resetCastles()"
                                          class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                                          <i class="fa-solid fa-trash mr-1"></i> Reset D·ªØ Li·ªáu Th√†nh
                                    </button>
                              </div>
                        </div>

                        <div class="flex justify-between items-center mb-4">
                              <h3 class="text-lg font-semibold text-gray-700">üìã Danh S√°ch C√°c T√≤a Th√†nh</h3>
                              <div class="space-x-2">
                                    <button id="btnExpandCastle" onclick="toggleCastle(true)"
                                          class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded hidden">
                                          <i class="fa-solid fa-chevron-down mr-1"></i> M·ªü r·ªông
                                    </button>
                                    <button id="btnCollapseCastle" onclick="toggleCastle(false)"
                                          class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded">
                                          <i class="fa-solid fa-chevron-up mr-1"></i> Thu g·ªçn
                                    </button>
                              </div>
                        </div>
                        <!-- ƒê√¢y l√† n∆°i ch·ª©a danh s√°ch c√°c t√≤a th√†nh -->
                        <div id="castle-section" class="expandable-section">
                              <div id="castle-list"
                                    class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                        </div>
                  </div>
            </section>

            <!-- PH·∫¶N 2: Ghi nh·∫≠n qu√¢n ƒë·ªôi di chuy·ªÉn v√†o c√°c t√≤a th√†nh -->
            <section id="battle-inputs" class="mb-10 px-4">
                  <div class="bg-white shadow rounded-xl p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">‚öîÔ∏è Ph·∫ßn 2: Ghi nh·∫≠n qu√¢n ƒë·ªôi di chuy·ªÉn v√†o c√°c
                              t√≤a th√†nh
                        </h2>

                        <!-- ƒêi·ªÅu h∆∞·ªõng v√≤ng ch∆°i -->
                        <div class="flex justify-between items-center mb-4 px-4">
                              <button onclick="prevRound()"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg "
                                    id="prevRoundBtn">‚¨ÖÔ∏è V√≤ng tr∆∞·ªõc</button>
                              <h3 class="text-xl font-bold text-blue-700" id="roundTitle">üåÄ V√íNG CH∆†I S·ªê 1</h3>
                              <button onclick="nextRound()"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg"
                                    id="nextRoundBtn">V√≤ng sau ‚û°Ô∏è</button>
                        </div>

                        <!-- V√πng hi·ªÉn th·ªã n·ªôi dung c√°c b·∫£ng nh·∫≠p li√™u -->
                        <div id="round-content" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4"></div>

                  </div>
            </section>




            <!-- Modal th√™m ƒë·ªôi -->
            <div id="teamModal"
                  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-40">
                  <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-lg relative">
                        <h3 class="text-2xl font-bold text-center mb-6 text-gray-800">üõ°Ô∏è Th√™m ƒê·ªôi M·ªõi</h3>

                        <!-- Nh·∫≠p t√™n ƒë·ªôi -->
                        <label for="teamNameInput" class="block text-sm font-medium text-gray-700 mb-1">T√™n ƒë·ªôi</label>
                        <input type="text" id="teamNameInput"
                              class="border border-gray-300 w-full p-2 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                              placeholder="Nh·∫≠p t√™n ƒë·ªôi">

                        <!-- Ch·ªçn ·∫£nh ƒë·∫°i di·ªán -->
                        <label class="block text-sm font-medium text-gray-700 mb-1">·∫¢nh ƒë·∫°i di·ªán</label>
                        <div class="flex items-center gap-3 mb-4">
                              <label for="teamAvatarInput"
                                    class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg cursor-pointer transition">
                                    Ch·ªçn h√¨nh ·∫£nh avatar
                              </label>
                              <span id="fileName" class="text-sm text-gray-600 italic hidden"></span>
                        </div>
                        <input type="file" id="teamAvatarInput" accept="image/*" class="hidden">
                        <img id="avatarPreview"
                              class="team-avatar hidden mb-4 border border-gray-200 shadow rounded-full w-20 h-20 object-cover mx-auto" />

                        <!-- N√∫t h√†nh ƒë·ªông -->
                        <div class="flex justify-end gap-3 mt-6">
                              <button onclick="closeTeamModal()"
                                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg transition">
                                    H·ªßy
                              </button>
                              <button onclick="confirmAddTeam()"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                                    Th√™m
                              </button>
                        </div>
                  </div>
            </div>

            <!-- Modal th√™m th√†nh AI -->
            <div id="castleModal"
                  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-40">
                  <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-md relative">
                        <h3 class="text-xl font-bold mb-4">üß± Th√™m T√≤a Th√†nh AI</h3>

                        <label class="block mb-2 text-sm font-medium text-gray-700">T√™n t√≤a th√†nh</label>
                        <input type="text" id="castleNameInput" class="border w-full p-2 mb-3 rounded"
                              placeholder="VD: Th√†nh ChatGPT">

                        <label class="block mb-2 text-sm font-medium text-gray-700">ƒêi·ªÉm vinh quang</label>
                        <input type="number" id="castleGloryInput" class="border w-full p-2 mb-3 rounded" min="1"
                              placeholder="VD: 30">

                        <label class="block mb-2 text-sm font-medium text-gray-700">S·ªë l·∫ßn c√≥ th·ªÉ chi·∫øm (1-5)</label>
                        <input type="number" id="castleCaptureInput" class="border w-full p-2 mb-3 rounded" min="1"
                              max="5" placeholder="VD: 3">

                        <label class="block mb-2 text-sm font-medium text-gray-700">Xu·∫•t hi·ªán v√≤ng:</label>
                        <select id="castleRoundInput" class="border w-full p-2 rounded mb-4">
                              <option value="">Ngay t·ª´ ƒë·∫ßu</option>
                              <option value="3">Ngay t·ª´ v√≤ng 3 (ng·∫´u nhi√™n)</option>
                              <option value="5">Ngay t·ª´ v√≤ng 5 (ng·∫´u nhi√™n)</option>
                        </select>

                        <div class="text-right space-x-2">
                              <button onclick="closeCastleModal()"
                                    class="bg-gray-400 text-white px-4 py-1 rounded">H·ªßy</button>
                              <button onclick="confirmAddCastle()"
                                    class="bg-blue-600 text-white px-4 py-1 rounded">Th√™m</button>
                        </div>
                  </div>
            </div>

            <!-- Modal Xem k·∫øt qu·∫£ v√≤ng ch∆°i b·∫±ng popup -->
            <div id="roundResultModal"
                  class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex justify-center items-center">
                  <div class="bg-white rounded-xl max-w-2xl w-full relative"
                        style="max-height: 80vh; overflow-y: auto;">
                        <!-- Ti√™u ƒë·ªÅ c·ªë ƒë·ªãnh -->
                        <div id="popupRoundTitle" class="border-b p-4 sticky top-0 bg-white z-10">

                        </div>

                        <!-- N·ªôi dung cu·ªôn -->
                        <div id="roundResultContent" class="p-4 max-h-[70vh] overflow-y-auto">
                              <!-- K·∫øt qu·∫£ s·∫Ω ƒë∆∞·ª£c inject ·ªü ƒë√¢y -->
                        </div>
                  </div>
            </div>

            <!-- Popup x√°c nh·∫≠n tr·ª´ qu√¢n th·ªß c√¥ng -->
            <div id="manualDeductModal"
                  class="fixed inset-0 bg-black bg-opacity-50 hidden z-40 flex justify-center items-center">
                  <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] flex flex-col">

                        <h3 class="text-xl font-bold text-blue-700 mb-4">‚öîÔ∏è Nh·∫≠p s·ªë qu√¢n c·∫ßn lo·∫°i b·ªè</h3>

                        <!-- N·ªôi dung ch√≠nh c√≥ th·ªÉ cu·ªôn -->
                        <div id="manualDeductContent" class="flex flex-wrap gap-4 overflow-y-auto pr-2"
                              style="max-height: 60vh;">
                              <!-- C√°c b·∫£ng ƒë·ªôi s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
                        </div>

                        <!-- N√∫t ƒëi·ªÅu khi·ªÉn gi·ªØ nguy√™n b√™n d∆∞·ªõi -->
                        <div class="flex justify-end gap-3 mt-4">
                              <button onclick="submitManualDeduction()"
                                    class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">üíæ X√°c
                                    nh·∫≠n</button>
                              <button onclick="closeManualDeductModal()"
                                    class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">‚ùå H·ªßy</button>
                        </div>
                  </div>
            </div>





      </div>

      <script>
            // Ph·∫ßn Setup ƒë·ªôi =======================================================================================
            let teams = [];
            // Show Th√¥ng b√°o
            const toastSuccess = document.getElementById("toastSuccess");
            const toastFailed = document.getElementById("toastFailed")
            function showToastSuccess(message) {
                  toastSuccess.innerHTML = `<i class="fa-regular fa-circle-check mr-2 text-white"></i> ${message}`;
                  toastSuccess.classList.remove("hidden");
                  setTimeout(() => toastSuccess.classList.add("hidden"), 4000);
            }
            function showToastFailed(message) {
                  toastFailed.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-2 text-white"></i> ${message}`;
                  toastFailed.classList.remove("hidden");
                  setTimeout(() => toastFailed.classList.add("hidden"), 4000);
            }
            // ·∫®n hi·ªán danh s√°ch c√°c ƒë·ªôi tham gia
            function toggleTeams(show) {
                  const section = document.getElementById("teams-section");
                  const btnExpand = document.getElementById("btnExpandTeams");
                  const btnCollapse = document.getElementById("btnCollapseTeams");

                  if (show) {
                        section.classList.remove("collapsed");
                        btnExpand.classList.add("hidden");
                        btnCollapse.classList.remove("hidden");
                  } else {
                        section.classList.add("collapsed");
                        btnCollapse.classList.add("hidden");
                        btnExpand.classList.remove("hidden");
                  }
            }

            // ·∫®n hi·ªán danh s√°ch c√°c T√≤a th√†nh AI
            function toggleCastle(show) {
                  const section = document.getElementById("castle-section");
                  const btnExpand = document.getElementById("btnExpandCastle");
                  const btnCollapse = document.getElementById("btnCollapseCastle");

                  if (show) {
                        section.classList.remove("collapsed"); // ‚úÖ hi·ªÉn th·ªã -> b·ªè collapsed
                        btnExpand.classList.add("hidden");
                        btnCollapse.classList.remove("hidden");
                  } else {
                        section.classList.add("collapsed"); // ‚úÖ ·∫©n -> th√™m collapsed
                        btnCollapse.classList.add("hidden");
                        btnExpand.classList.remove("hidden");
                  }
            }


            // M·ªü Popup th√™m ƒë·ªôi
            function openTeamModal() {
                  document.getElementById("teamModal").classList.remove("hidden");
            }

            function closeTeamModal() {
                  document.getElementById("teamModal").classList.add("hidden");
                  document.getElementById("teamNameInput").value = "";
                  document.getElementById("teamAvatarInput").value = "";
                  document.getElementById("avatarPreview").classList.add("hidden");
            }

            document.getElementById("teamAvatarInput").addEventListener("change", function (event) {
                  const reader = new FileReader();
                  reader.onload = function (e) {
                        const avatar = e.target.result;
                        const img = document.getElementById("avatarPreview");
                        img.src = avatar;
                        img.classList.remove("hidden");
                  };
                  reader.readAsDataURL(event.target.files[0]);
            });

            function confirmAddTeam() {
                  console.log(teams.length)
                  if (teams.length >= 5) {
                        showToastFailed("ƒê√£ ƒë·∫°t t·ªëi ƒëa 5 ƒë·ªôi ch∆°i.");
                        closeTeamModal();
                        return;
                  }
                  const name = document.getElementById("teamNameInput").value.trim();
                  const fileInput = document.getElementById("teamAvatarInput");
                  if (!name || !fileInput.files.length) {
                        showToastFailed("Vui l√≤ng nh·∫≠p t√™n v√† ch·ªçn ·∫£nh ƒë·∫°i di·ªán.");
                        return;
                  }
                  const reader = new FileReader();
                  reader.onload = function (e) {
                        const avatar = e.target.result;
                        const id = Date.now();
                        let soldiers = { hauphuong: 180, tientuyen: 90, congnghe: 60 };
                        // Th√™m 1 bi·∫øn t·ªïng qu√¢n n·ªØa totalSoldiers
                        let totalSoldiers = soldiers.hauphuong + soldiers.tientuyen + soldiers.congnghe;
                        let strength = soldiers.hauphuong * 1 + soldiers.tientuyen * 2 + soldiers.congnghe * 3;
                        let glory = 0;
                        let newTeam = {
                              id,
                              name,
                              avatar,
                              soldiers,
                              totalSoldiers,
                              strength,
                              glory,
                        };
                        teams.push(newTeam);
                        renderTeams();
                        saveTeams();
                        showToastSuccess("ƒê√£ th√™m ƒë·ªôi th√†nh c√¥ng!");
                        closeTeamModal();
                  };
                  reader.readAsDataURL(fileInput.files[0]);
            }

            function renderTeams() {
                  const container = document.getElementById("teams-container");
                  container.innerHTML = "";
                  teams.forEach(team => {
                        const div = document.createElement("div");
                        div.className = "p-4  relative";
                        // ‚úÖ Th√™m class n·∫øu ƒë·ªôi b·ªã lo·∫°i
                        const extraClass = team.eliminated ? "opacity-50 border-red-400" : "border-gray-200";
                        const eliminatedNotice = team.eliminated
                              ? `<p class="text-red-600 font-semibold mt-2">üíÄ ƒê·ªôi n√†y ƒë√£ b·ªã lo·∫°i kh·ªèi tr·∫≠n chi·∫øn!</p>`
                              : "";

                        div.innerHTML = `
  <div class="relative p-4 bg-white rounded-xl cart-team-shadow transition">
    <!-- N√∫t x√≥a -->
    <button onclick="deleteTeam(${team.id})"
            class="absolute top-2 right-2 text-gray-400 hover:text-red-600 transition text-lg"
            title="Xo√° ƒë·ªôi">
      <i class="fa-solid fa-xmark"></i>
    </button>

    <!-- N·ªôi dung ƒë·ªôi -->
    <div class="flex gap-4 items-center">
      <!-- Avatar gi·ªØa -->
      <img src="${team.avatar}" alt="Avatar ƒë·ªôi"
           class="w-20 h-20 rounded-full object-cover border-2 border-blue-400 shadow" />

      <div class="flex-1">
        <h4 class="text-lg font-bold text-gray-800 mb-3">ƒê·ªôi: ${team.name}</h4>
        <table class="w-full text-sm border border-gray-300 rounded overflow-hidden">
          <tbody>
            <tr class="border-b border-gray-200">
              <td class="py-1 px-2">üèπ H·∫≠u Ph∆∞∆°ng:</td>
              <td class="text-blue-700 font-medium">${team.soldiers.hauphuong}</td>
              <td class="py-1 px-2 text-green-600 font-bold">üí™ S·ª©c M·∫°nh:</td>
              <td class="text-green-600 font-bold">${team.strength} ƒëi·ªÉm</td>
            </tr>
            <tr class="border-b border-gray-200">
              <td class="py-1 px-2">‚öîÔ∏è Ti·ªÅn Tuy·∫øn:</td>
              <td class="text-red-600 font-medium">${team.soldiers.tientuyen}</td>
              <td class="py-1 px-2 text-yellow-600 font-bold">üèÜ Vinh Quang:</td>
              <td class="text-yellow-600 font-bold">${team.glory} ƒëi·ªÉm</td>
            </tr>
            <tr class="border-b border-gray-200">
              <td class="py-1 px-2">ü§ñ C√¥ng Ngh·ªá:</td>
              <td class="text-purple-700 font-medium">${team.soldiers.congnghe}</td>
              
            </tr>
            <tr>
              <td class="py-1 px-2">ü™ñ T·ªïng S·ªë Qu√¢n:</td>
              <td colspan="3" class="font-medium">${team.totalSoldiers}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
`;
                        container.appendChild(div);
                  });
            }

            function deleteTeam(id) {
                  teams = teams.filter(team => team.id !== id);
                  saveTeams();
                  renderTeams();
                  showToastSuccess("ƒê√£ xo√° ƒë·ªôi th√†nh c√¥ng");
            }

            function saveTeams() {
                  localStorage.setItem("dau-truong-ai-teams", JSON.stringify(teams));
                  console.log("Teams saved:", teams);
            }

            function resetTeams() {
                  if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu c√°c ƒë·ªôi?")) {
                        localStorage.removeItem("dau-truong-ai-teams");
                        teams = [];
                        renderTeams();
                        showToastSuccess("ƒê√£ reset to√†n b·ªô ƒë·ªôi th√†nh c√¥ng.");
                  }
            }

            function loadTeamsFromStorage() {
                  const stored = localStorage.getItem("dau-truong-ai-teams");
                  if (stored) {
                        teams = JSON.parse(stored);
                        renderTeams();
                  }
            }

            // Ph·∫ßn setup Th√†nh AI =====================================================================================
            let castles = [];

            function openCastleModal() {
                  document.getElementById("castleModal").classList.remove("hidden");
            }

            function closeCastleModal() {
                  document.getElementById("castleModal").classList.add("hidden");
                  document.getElementById("castleNameInput").value = "";
                  document.getElementById("castleGloryInput").value = "";
                  document.getElementById("castleCaptureInput").value = "";
                  document.getElementById("castleRoundInput").value = "";
            }
            function confirmAddCastle() {
                  const name = document.getElementById("castleNameInput").value.trim();
                  const gloryPoint = parseInt(document.getElementById("castleGloryInput").value);
                  const maxCaptures = parseInt(document.getElementById("castleCaptureInput").value);
                  const appearsAtRound = document.getElementById("castleRoundInput").value || null;

                  if (!name || !gloryPoint || !maxCaptures || maxCaptures < 1 || maxCaptures > 5) {
                        showToastFailed("Vui l√≤ng nh·∫≠p ƒë√∫ng th√¥ng tin!");
                        return;
                  }

                  const castle = {
                        id: Date.now(),
                        name,
                        gloryPoint,
                        maxCaptures,
                        appearsAtRound: appearsAtRound ? parseInt(appearsAtRound) : null
                  };

                  castles.push(castle);
                  saveCastles();
                  renderCastles();
                  showToastSuccess("ƒê√£ th√™m t√≤a th√†nh!");
                  closeCastleModal();
            }
            function renderCastles() {
                  const list = document.getElementById("castle-list");
                  list.innerHTML = "";

                  castles.forEach(c => {
                        const div = document.createElement("div");
                        div.className = "p-4 bg-gray-50 rounded shadow border relative";

                        div.innerHTML = `
      <button onclick="deleteCastle(${c.id})"
              class="absolute top-2 right-2 text-gray-400 hover:text-red-600 text-lg">
        <i class="fa-solid fa-xmark"></i>
      </button>
      <h3 class="text-lg font-bold text-gray-800 mb-2">üèØ ${c.name}</h3>
      <p>üèÜ Vinh quang: <span class="font-semibold text-orange-600">${c.gloryPoint}</span> ƒëi·ªÉm</p>
      <p>üéØ S·ªë l·∫ßn chi·∫øm: <span class="text-blue-600 font-medium">${c.maxCaptures}</span> l·∫ßn</p>
      <p>üìç Xu·∫•t hi·ªán: ${c.appearsAtRound ? `T·ª´ v√≤ng ${c.appearsAtRound}` : "T·ª´ ƒë·∫ßu tr·∫≠n"}</p>
    `;

                        list.appendChild(div);
                  });
            }
            function saveCastles() {
                  localStorage.setItem("dau-truong-ai-castles", JSON.stringify(castles));
            }

            function loadCastlesFromStorage() {
                  const stored = localStorage.getItem("dau-truong-ai-castles");
                  castles = stored ? JSON.parse(stored) : [];

                  // Ki·ªÉm tra xem ƒë√£ c√≥ "Th√†nh Xu·∫•t Ph√°t" ch∆∞a
                  const hasStartCastle = castles.some(c => c.id === "start" || c.name === "Xu·∫•t Ph√°t");
                  if (!hasStartCastle) {
                        castles.unshift({
                              id: "start",
                              name: "Xu·∫•t Ph√°t",
                              gloryPoint: 0,
                              maxCaptures: 0,
                              isDefault: true
                        });
                        saveCastles(); // L∆∞u l·∫°i n·∫øu v·ª´a th√™m m·ªõi
                  }
                  renderCastles(); // C·∫≠p nh·∫≠t UI
            }

            function deleteCastle(id) {
                  castles = castles.filter(c => c.id !== id);
                  saveCastles();
                  renderCastles();
                  showToastSuccess("ƒê√£ xo√° t√≤a th√†nh");
            }

            function resetCastles() {
                  if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° to√†n b·ªô t√≤a th√†nh?")) {
                        localStorage.removeItem("dau-truong-ai-castles");
                        castles = [];
                        renderCastles();
                        showToastSuccess("ƒê√£ reset danh s√°ch t√≤a th√†nh.");
                  }
            }


            // Ph·∫ßn 2 Ghi nh·∫≠n qu√¢n ƒë·ªôi di chuy·ªÉn v√†o c√°c t√≤a th√†nh ===============================================
            // T·∫°o c√°c b·∫£ng nh·∫≠p li·ªáu qu√¢n v√†o t·ª´ng th√†nh
            function generateCastleBattleTable(castle) {
                  const table = document.createElement("table");
                  table.className = "w-full mb-4 border-2 border-gray-300 bg-white text-sm cart-table-shadow table-fixed";

                  const thead = `
    <thead class="bg-blue-100">
      <tr>
        <th class="px-2 py-1 text-center w-[30%]">T√™n ƒê·ªôi</th>
        <th class="px-2 py-1 text-center w-[15%]">üèπ HP</th>
        <th class="px-2 py-1 text-center w-[15%]">‚öîÔ∏è TT</th>
        <th class="px-2 py-1 text-center w-[15%]">ü§ñ CN</th>
        <th class="px-2 py-1 text-center w-[25%]">TSM</th>
      </tr>
    </thead>
  `;

                  const rows = [];
                  teams.slice(0, 5).forEach(team => {
                        rows.push(`
                        <tr data-team-id="${team.id}">
                              <td class="w-[30%] font-bold text-gray-800 px-2 py-1">${team.name}</td>
                              <td class="w-[15%]">
                              <input type="number" class="hauphuong-input text-center border-2 rounded-lg px-1 py-0.5 w-full" min="0">
                              </td>
                              <td class="w-[15%]">
                              <input type="number" class="tientuyen-input text-center border-2 rounded-lg px-1 py-0.5 w-full" min="0">
                              </td>
                              <td class="w-[15%]">
                              <input type="number" class="congnghe-input text-center border-2 rounded-lg px-1 py-0.5 w-full" min="0">
                              </td>
                              <td class="w-[25%] total-strength text-center font-bold">0</td>
                        </tr>
                        `);
                  });


                  const captureColor = castle.maxCaptures > 0 ? "yes-chiem" : "no-chiem";

                  table.innerHTML = `
                        <caption class="py-2 bg-gray-500 text-white">
                        <div class="flex justify-between text-sm font-bold w-full px-2">
                              <span>üèØ ${castle.name}</span> |
                              <span>üèÜ Vinh quang: ${castle.gloryPoint}</span> |
                              <span class="${captureColor}">üéØ S·ªë l·∫ßn chi·∫øm c√≤n l·∫°i: ${castle.maxCaptures}</span>
                        </div>
                        </caption>
                        ${thead}
                        <tbody>${rows.join("")}</tbody>
                        `;


                  return table;
            }


            // T√≠nh t·ªïng s·ª©c m·∫°nh t·ª± ƒë·ªông
            function attachStrengthCalculator(container) {
                  container.addEventListener("input", e => {
                        const row = e.target.closest("tr");
                        if (!row) return;
                        const hau = parseInt(row.querySelector(".hauphuong-input")?.value || 0);
                        const tien = parseInt(row.querySelector(".tientuyen-input")?.value || 0);
                        const cong = parseInt(row.querySelector(".congnghe-input")?.value || 0);
                        const total = hau * 1 + tien * 2 + cong * 3;
                        row.querySelector(".total-strength").textContent = total;
                  });
            }


            // Logic ph√¢n trang b·∫±ng JavaScript
            let currentRound = 1;
            const totalRounds = 7;

            // T·∫°o b·∫£ng theo t·ª´ng v√≤ng (d·∫°ng ph√¢n trang)
            function renderRoundPage(round) {
                  const container = document.getElementById("round-content");

                  // B·∫Øt ƒë·∫ßu hi·ªáu ·ª©ng fade-out
                  container.classList.add("fade-out");

                  setTimeout(() => {
                        // Sau 300ms m·ªõi thay ƒë·ªïi n·ªôi dung
                        container.innerHTML = "";

                        const title = document.getElementById("roundTitle");
                        title.textContent = `<(------------------- üåÄ V√íNG CH∆†I S·ªê ${round} -------------------)>`;

                        const inputData = JSON.parse(localStorage.getItem(`round-input-${round}`) || "[]");

                        // Th√†nh n√†o c√≥ appearsAtRound <= round th√¨ s·∫Ω hi·ªÉn th·ªã (t·ªìn t·∫°i li√™n t·ª•c t·ª´ ƒë√≥ ƒë·∫øn v√≤ng 7)
                        const currentCastles = castles.filter(c => {
                              const appearRound = parseInt(c.appearsAtRound) || 1; // N·∫øu kh√¥ng c√≥, m·∫∑c ƒë·ªãnh l√† v√≤ng 1
                              return appearRound <= round;
                        });

                        currentCastles.forEach(castle => {
                              const table = generateCastleBattleTable(castle);
                              container.appendChild(table);

                              // ‚úÖ G√°n l·∫°i d·ªØ li·ªáu nh·∫≠p
                              const storedCastle = inputData.find(item => item.castleId === castle.id);
                              if (storedCastle) {
                                    const rows = table.querySelectorAll("tbody tr");
                                   
                                    // L·∫•y d·ªØ li·ªáu k·∫øt qu·∫£ tr·∫≠n ƒë·∫•u t·ª´ localStorage
                                    const roundResultData = JSON.parse(localStorage.getItem(`round-result-${round}`) || "[]");
                                    const castleResult = roundResultData.find(r => r.castleId === castle.id);

                                    storedCastle.teamEntries.forEach((entry, index) => {
                                          const row = rows[index];
                                          if (!row) return;

                                          const teamId = row.dataset.teamId;
                                          if (teamId != entry.teamId) return;

                                          row.querySelector(".hauphuong-input").value = entry.hau;
                                          row.querySelector(".tientuyen-input").value = entry.tien;
                                          row.querySelector(".congnghe-input").value = entry.cong;
                                          row.querySelector(".total-strength").textContent = entry.totalStrength;

                                          // ‚úÖ G√°n m√†u t√πy theo k·∫øt qu·∫£
                                          if (castleResult && entry.hau > 0 && entry.tien > 0 && entry.cong > 0) {
                                                if (castleResult.winner == teamId) {
                                                      row.classList.add("bg-green-200");
                                                } else if (castleResult.losers.includes(teamId)) {
                                                      row.classList.add("bg-red-200");
                                                }
                                          }
                                    });

                              }
                        });

                        attachStrengthCalculator(container);

                        // ‚úÖ Th√™m c√°c n√∫t x·ª≠ l√Ω d∆∞·ªõi b·∫£ng
                        const btnGroup = document.createElement("div");
                        btnGroup.className = "flex gap-4 justify-end my-4 col-span-full";
                        btnGroup.innerHTML = `
                              <button onclick="processRoundData(${round})" class="px-4 py-2 rounded-lg bg-green-600 text-white rounded hover:bg-green-700">
                              ‚úÖ X·ª≠ l√Ω k·∫øt qu·∫£ v√≤ng ${round}
                              </button>
                              <button onclick="viewRoundResult(${round})" class="px-4 py-2 rounded-lg bg-blue-600 text-white rounded hover:bg-blue-700">
                              üìä Xem k·∫øt qu·∫£ v√≤ng ${round}
                              </button>
                              <button onclick="resetRoundData(${round})" class="px-4 py-2 rounded-lg bg-red-600 text-white rounded hover:bg-red-700">
                              ‚ôªÔ∏è Reset k·∫øt qu·∫£ V√≤ng ${round}
                              </button>
                        `;
                        container.appendChild(btnGroup);

                        // K·∫øt th√∫c fade-out, b·∫Øt ƒë·∫ßu fade-in
                        container.classList.remove("fade-out");

                        // V√¥ hi·ªáu h√≥a n√∫t khi ƒë·∫øn gi·ªõi h·∫°n
                        document.getElementById("prevRoundBtn").disabled = round === 1;
                        document.getElementById("nextRoundBtn").disabled = round === totalRounds;

                  }, 300); // delay kh·ªõp v·ªõi transition trong CSS
            }

            // X√≥a data t·ª´ng v√≤ng
            function resetRoundData(round) {
                  if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën reset to√†n b·ªô d·ªØ li·ªáu c·ªßa v√≤ng ${round}?`)) return;
                  localStorage.removeItem(`round-result-${round}`);
                  localStorage.removeItem(`round-input-${round}`);
                  renderRoundPage(round);
                  showToastSuccess(`ƒê√£ reset d·ªØ li·ªáu v√≤ng ${round}`);
            }

            // Hi·ªÉn thi popup tr·ª´ qu√¢n khi giao tranh th·∫•t b·∫°i
            function showManualDeductionPopup() {
                  const container = document.getElementById("manualDeductContent");
                  container.innerHTML = "";

                  window.manualDeductionQueue.forEach((entry, idx) => {
                        const team = teams.find(t => t.id == entry.teamId);
                        container.innerHTML += `
                              <div class="p-4 border-2 rounded-xl cart-table-shadow bg-color-gray-red">
                              <p class="mb-2 font-semibold text-gray-800">
                              üíÄ T·∫°i th√†nh <strong>${entry.castleName}</strong> C√≥ ƒë·ªôi: <strong>${team.name}</strong> giao tranh th·∫•t b·∫°i<br>
                              ‚ûñ C·∫ßn lo·∫°i qu√¢n c√≥ t·ªïng s·ª©c m·∫°nh = <strong>${entry.glory}</strong>
                              </p>
                              <div class="grid grid-cols-3 gap-2">
                              <div>
                                    <label>H·∫≠u Ph∆∞∆°ng</label>
                                    <input type="number" class="form-input w-full border px-2 py-1" min="0" data-team="${team.id}" data-key="${team.id}-${entry.castleName}" data-type="hauphuong">
                              </div>
                              <div>
                                    <label>Ti·ªÅn Tuy·∫øn</label>
                                    <input type="number" class="form-input w-full border px-2 py-1" min="0" data-team="${team.id}" data-key="${team.id}-${entry.castleName}" data-type="tientuyen">
                              </div>
                              <div>
                                    <label>C√¥ng Ngh·ªá</label>
                                    <input type="number" class="form-input w-full border px-2 py-1" min="0" data-team="${team.id}" data-key="${team.id}-${entry.castleName}" data-type="congnghe">
                              </div>
                              </div>
                              </div>
                        `;
                  });

                  document.getElementById("manualDeductModal").classList.remove("hidden");
            }

            function submitManualDeduction() {
                  const inputs = document.querySelectorAll("#manualDeductContent input");
                  const deductionInputs = {}; // key = `${teamId}-${castleName}`

                  // B∆∞·ªõc 1: Thu th·∫≠p d·ªØ li·ªáu t·ª´ c√°c √¥ input
                  inputs.forEach(input => {
                        const key = input.dataset.key; // teamId-castleName
                        const type = input.dataset.type; // hauphuong, tientuyen, congnghe
                        const value = parseInt(input.value || 0);

                        if (!deductionInputs[key]) {
                              deductionInputs[key] = { hauphuong: 0, tientuyen: 0, congnghe: 0 };
                        }

                        deductionInputs[key][type] = value;
                  });

                  // B∆∞·ªõc 2: Ki·ªÉm tra h·ª£p l·ªá to√†n b·ªô tr∆∞·ªõc khi tr·ª´ qu√¢n
                  let isValid = true;
                  const errors = [];

                  window.manualDeductionQueue.forEach(entry => {
                        const key = `${entry.teamId}-${entry.castleName}`;
                        const deduction = deductionInputs[key];
                        const strength = deduction.hauphuong * 1 + deduction.tientuyen * 2 + deduction.congnghe * 3;

                        if (strength !== entry.glory) {
                              isValid = false;
                              errors.push(`‚ö†Ô∏è ƒê·ªôi ${entry.teamName} t·∫°i ${entry.castleName} c·∫ßn t·ªïng s·ª©c m·∫°nh = ${entry.glory}, hi·ªán t·∫°i l√† ${strength}`);
                        }
                  });

                  if (!isValid) {
                        showToastFailed(errors.join("<br>"));
                        return;
                  }

                  // B∆∞·ªõc 3: N·∫øu h·ª£p l·ªá ‚Üí Tr·ª´ qu√¢n th·∫≠t s·ª±
                  window.manualDeductionQueue.forEach(entry => {
                        const team = teams.find(t => t.id == entry.teamId);
                        const key = `${entry.teamId}-${entry.castleName}`;
                        const deduction = deductionInputs[key];

                        team.soldiers.hauphuong = Math.max(0, team.soldiers.hauphuong - deduction.hauphuong);
                        team.soldiers.tientuyen = Math.max(0, team.soldiers.tientuyen - deduction.tientuyen);
                        team.soldiers.congnghe = Math.max(0, team.soldiers.congnghe - deduction.congnghe);

                        const total = team.soldiers.hauphuong + team.soldiers.tientuyen + team.soldiers.congnghe;
                        team.totalSoldiers = total;
                        team.strength = team.soldiers.hauphuong * 1 + team.soldiers.tientuyen * 2 + team.soldiers.congnghe * 3;

                        if (total === 0) team.eliminated = true;
                  });

                  saveTeams();
                  renderTeams();
                  document.getElementById("manualDeductModal").classList.add("hidden");
                  showToastSuccess("‚úÖ ƒê√£ c·∫≠p nh·∫≠t tr·ª´ qu√¢n th·ªß c√¥ng th√†nh c√¥ng.");
            }



            // H√†m ch√≠nh x·ªØ l√Ω s·ª± ki·ªán click ‚úÖ X·ª≠ l√Ω k·∫øt qu·∫£ v√≤ng
            function processRoundData(round) {
                  const tables = document.querySelectorAll("#round-content table");
                  const roundData = [];
                  const inputData = [];

                  window.manualDeductionQueue = []; // D√πng bi·∫øn to√†n c·ª•c ƒë·ªÉ chia s·∫ª cho popup
                  const addedTeams = new Set(); // ƒê·∫£m b·∫£o kh√¥ng tr√πng ƒë·ªôi

                  tables.forEach(table => {
                        const { castle, teamEntries } = extractCastleDataFromTable(table);
                        if (!castle) return; // B·ªè qua Th√†nh Xu·∫•t Ph√°t

                        // ‚úÖ Lu√¥n l∆∞u l·∫°i d·ªØ li·ªáu input d√π c√≥ giao chi·∫øn hay kh√¥ng
                        inputData.push({ castleId: castle.id, teamEntries });

                        // N·∫øu th√†nh ƒë√£ h·∫øt l∆∞·ª£t chi·∫øm, kh√¥ng c√≥ giao chi·∫øn
                        if (castle.maxCaptures <= 0) {
                              roundData.push({
                                    castleId: castle.id,
                                    castleName: castle.name,
                                    glory: castle.gloryPoint,
                                    winner: null,
                                    losers: [],
                                    troops: teamEntries,
                                    message: "‚õî T√≤a th√†nh ƒë√£ h·∫øt l∆∞·ª£t chi·∫øm - kh√¥ng c√≤n x·∫£y ra giao tranh."
                              });
                              return;
                        }

                        // ‚úÖ N·∫øu c√≤n l∆∞·ª£t chi·∫øm ‚Üí x·ª≠ l√Ω giao tranh
                        const result = calculateBattleResult(castle, teamEntries);
                        roundData.push(result);

                        // ‚úÖ N·∫øu c√≥ ƒë·ªôi th·∫•t b·∫°i th√¨ ƒë∆∞a v√†o danh s√°ch c·∫ßn nh·∫≠p s·ªë qu√¢n ƒë·ªÉ tr·ª´
                        if (result.winner !== null) {
                              result.troops.forEach(troop => {
                                    const isLoser = result.winner !== troop.teamId;
                                    const joinedBattle = troop.hau > 0 && troop.tien > 0 && troop.cong > 0;
                                    const key = `${troop.teamId}-${castle.id}`;

                                    if (isLoser && joinedBattle && !addedTeams.has(key)) {
                                          const team = teams.find(t => t.id == troop.teamId);
                                          if (team && !team.eliminated) {
                                                window.manualDeductionQueue.push({
                                                      teamId: team.id,
                                                      teamName: team.name,
                                                      castleName: result.castleName,
                                                      glory: result.glory
                                                });
                                                addedTeams.add(key);
                                          }
                                    }
                              });
                        }
                  });

                  if (roundData.length === 0) {
                        showToastFailed("Kh√¥ng c√≥ d·ªØ li·ªáu n√†o ƒë·ªÉ x·ª≠ l√Ω v√≤ng n√†y.");
                        return;
                  }

                  // ‚úÖ L∆∞u d·ªØ li·ªáu tr∆∞·ªõc khi popup hi·ªán ra
                  localStorage.setItem(`round-result-${round}`, JSON.stringify(roundData));
                  localStorage.setItem(`round-input-${round}`, JSON.stringify(inputData));

                  // ‚úÖ C·∫≠p nh·∫≠t UI v√† localStorage
                  saveCastles();
                  saveTeams();
                  renderTeams();
                  renderCastles();
                  renderRoundPage(currentRound);

                  // ‚úÖ Hi·ªán popup ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫≠p s·ªë qu√¢n b·ªã lo·∫°i n·∫øu c√≥
                  if (manualDeductionQueue.length > 0) {
                        window.pendingManualDeductionRound = round;
                        window.pendingManualDeductionQueue = manualDeductionQueue;
                        showManualDeductionPopup(manualDeductionQueue);
                  } else {
                        showToastSuccess(`‚úÖ ƒê√£ x·ª≠ l√Ω k·∫øt qu·∫£ v√≤ng ${round}`);
                  }
            }


            // H√†m ph·ª•: Tr√≠ch xu·∫•t d·ªØ li·ªáu t·ª´ b·∫£ng th√†nh
            function extractCastleDataFromTable(table) {
                  const captionText = table.caption.textContent;
                  const castleName = captionText.split("|")[0].replace("üèØ", "").trim();
                  const castle = castles.find(c => c.name.trim() === castleName);
                  if (!castle) return { castle: null, teamEntries: [] };

                  const rows = table.querySelectorAll("tbody tr");
                  const teamEntries = [];

                  rows.forEach(row => {
                        const teamId = row.dataset.teamId;
                        if (!teamId) return;

                        const hau = parseInt(row.querySelector(".hauphuong-input").value || 0);
                        const tien = parseInt(row.querySelector(".tientuyen-input").value || 0);
                        const cong = parseInt(row.querySelector(".congnghe-input").value || 0);

                        teamEntries.push({
                              teamId,
                              hau,
                              tien,
                              cong,
                              totalStrength: hau * 1 + tien * 2 + cong * 3
                        });
                  });

                  return { castle, teamEntries };
            }
            // H√†m ph·ª•: T√≠nh k·∫øt qu·∫£ giao tranh t·∫°i 1 th√†nh
            function calculateBattleResult(castle, teamEntries) {
                  // L·ªçc c√°c ƒë·ªôi c√≥ ƒë·ªß 3 lo·∫°i qu√¢n
                  const qualified = teamEntries.filter(t => t.hau > 0 && t.tien > 0 && t.cong > 0);

                  const result = {
                        castleId: castle.id,
                        castleName: castle.name,
                        glory: castle.gloryPoint,
                        winner: null,
                        losers: [],
                        troops: teamEntries,
                        message: ""
                  };

                  if (qualified.length === 0) {
                        result.message = "‚õî Kh√¥ng ƒë·ªôi n√†o ƒë·ªß c·∫£ 3 lo·∫°i qu√¢n ‚Äì kh√¥ng c√≥ giao tranh.";
                        return result;
                  }

                  // T√≠nh ƒëi·ªÉm s·ª©c m·∫°nh cho c√°c ƒë·ªôi h·ª£p l·ªá
                  qualified.forEach(t => {
                        t.totalStrength = t.hau * 1 + t.tien * 2 + t.cong * 3;
                  });

                  // S·∫Øp x·∫øp gi·∫£m d·∫ßn theo s·ª©c m·∫°nh
                  qualified.sort((a, b) => b.totalStrength - a.totalStrength);
                  const top = qualified[0];

                  // Ki·ªÉm tra c√≥ b·ªã h√≤a kh√¥ng
                  const tie = qualified.filter(t => t.totalStrength === top.totalStrength);
                  if (tie.length === 1) {
                        // ‚úÖ C√≥ 1 ƒë·ªôi m·∫°nh nh·∫•t ‚Üí th·∫Øng
                        result.winner = top.teamId;
                        castle.maxCaptures = Math.max(0, castle.maxCaptures - 1);

                        const team = teams.find(t => t.id == top.teamId);
                        if (team) {
                              team.glory += castle.gloryPoint;
                        }

                        result.message = `‚úÖ ƒê·ªôi ${team?.name || top.teamId} chi·∫øn th·∫Øng t·∫°i Th√†nh: ${castle.name} `;

                        // X√°c ƒë·ªãnh danh s√°ch c√°c ƒë·ªôi thua (c√≥ tham gia giao tranh)
                        result.losers = qualified
                              .filter(t => t.teamId !== result.winner)
                              .map(t => t.teamId);

                  } else {
                        // ‚ùå H√≤a ‚Äì kh√¥ng ai th·∫Øng
                        result.message = "‚öîÔ∏è Nhi·ªÅu ƒë·ªôi c√≥ c√πng ƒëi·ªÉm s·ª©c m·∫°nh cao nh·∫•t ‚Äì kh√¥ng ai chi·∫øm th√†nh.";
                  }

                  saveTeams();
                  return result;
            }



            // H√†m ch√≠nh x·ª≠ l√Ω s·ª± ki·ªán click üìä Xem k·∫øt qu·∫£ v√≤ng
            function viewRoundResult(round) {
                  const data = localStorage.getItem(`round-result-${round}`);
                  const container = document.getElementById("roundResultContent");
                  const titlePopup = document.getElementById("popupRoundTitle");
                  // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ popup
                  titlePopup.innerHTML = `
                        <h3 class="text-xl font-bold mb-4 text-blue-700">üìä K·∫øt Qu·∫£ V√≤ng ${round}</h3>
                        <button onclick="closeResultModal()"
                              class="absolute top-2 right-3 text-gray-400 hover:text-red-500 text-lg">
                              <i class="fa-solid fa-xmark"></i>
                        </button>
                        `;
                  container.innerHTML = "";  // X√≥a k·∫øt qu·∫£ c≈©
                  if (!data) {
                        container.innerHTML += `<p class="text-red-600">Ch∆∞a c√≥ d·ªØ li·ªáu x·ª≠ l√Ω v√≤ng ${round}.</p>`;
                  } else {
                        const results = JSON.parse(data);
                        results.forEach(res => {
                              const winnerTeam = teams.find(t => t.id == res.winner)?.name || "Kh√¥ng c√≥";
                              const losers = res.losers.map(id => teams.find(t => t.id == id)?.name || "??").join(", ");
                              const totalTroops = res.troops.reduce((sum, t) => sum + t.hau + t.tien + t.cong, 0);
                              // Ki·ªÉm tra ƒë·ªôi n√†o b·ªã lo·∫°i
                              let eliminatedHTML = "";
                              res.losers.forEach(teamId => {
                                    const team = teams.find(t => t.id == teamId);
                                    if (team && team.hau + team.tien + team.cong === 0) {
                                          eliminatedHTML += `<p class="text-red-500 font-semibold">üíÄ ƒê·ªôi ${team.name} ƒë√£ b·ªã lo·∫°i!</p>`;
                                    }
                              });
                              container.innerHTML += `
                                    <div class="border-2 p-3 rounded-xl cart-table-shadow bg-gray-100 mb-4">
                                    <p><strong>üèØ Th√†nh:</strong> ${res.castleName}</p>
                                    <p><strong>üéñÔ∏è ƒêi·ªÉm Vinh Quang:</strong> ${res.glory}</p>
                                    <p><strong>ü™ñ T·ªïng s·ªë qu√¢n hi·ªán c√≥ trong th√†nh:</strong> ${totalTroops}</p>
                                    <p>------------------------</p>
                                    <p><strong>ü•á Chi·∫øm th√†nh:</strong> ${winnerTeam}</p>
                                    <p><strong>‚ùå Th·∫•t b·∫°i:</strong> ${losers || "Kh√¥ng c√≥"}</p>
                                    ${eliminatedHTML}
                                    ${res.message ? `<p class="text-gray-500 italic">üìå ${res.message}</p>` : ""}
                                    </div>
                                    `;
                        });
                  }
                  document.getElementById("roundResultModal").classList.remove("hidden");
            }

            function closeResultModal() {
                  document.getElementById("roundResultModal").classList.add("hidden");
            }

            function prevRound() {
                  if (currentRound > 1) {
                        currentRound--;
                        renderRoundPage(currentRound);
                  }
            }

            function nextRound() {
                  if (currentRound < totalRounds) {
                        currentRound++;
                        renderRoundPage(currentRound);
                  }
            }

            window.onload = function () {
                  loadTeamsFromStorage();
                  loadCastlesFromStorage();
                  renderRoundPage(currentRound);
            };


      </script>
</body>

</html>